#!/command/with-contenv bash

### Set Defaults
ENABLE_PHP_FPM=${ENABLE_PHP_FPM:-"TRUE"}
PHP_APC_SHM_SIZE=${PHP_APC_SHM_SIZE:-"128M"}
PHP_APC_TTL=${PHP_APC_TTL:-"7200"}
PHP_FPM_CONTAINER_MODE=${PHP_FPM_CONTAINER_MODE:-"nginx-php-fpm"}
PHP_DISPLAY_ERRORS=${PHP_DISPLAY_ERRORS:-"FALSE"}
PHP_ENABLE_CREATE_SAMPLE_PHP=${PHP_ENABLE_CREATE_SAMPLE_PHP:-"TRUE"}
PHP_HIDE_X_POWERED_BY=${PHP_HIDE_X_POWERED_BY:-"TRUE"}
PHP_KITCHENSINK=${PHP_KITCHENSINK:-"FALSE"}
PHP_FPM_LISTEN_IP=${PHP_FPM_LISTEN_IP:-"0.0.0.0"}
PHP_FPM_LISTEN_TYPE=${PHP_FPM_LISTEN_TYPE:-"unix"}
PHP_FPM_LISTEN_PORT=${PHP_FPM_LISTEN_PORT:-"9000"}
PHP_FPM_LISTEN_TCP_IP=${PHP_FPM_LISTEN_TCP_IP:-"${PHP_FPM_LISTEN_IP}"}
PHP_FPM_LISTEN_TCP_IP_ALLOWED=${PHP_FPM_LISTEN_TCP_IP_ALLOWED:-"127.0.0.1"}
PHP_FPM_LISTEN_TCP_PORT=${PHP_FPM_LISTEN_TCP_PORT:-"${PHP_FPM_LISTEN_PORT}"}
PHP_FPM_LISTEN_UNIX_SOCKET=${PHP_FPM_LISTEN_UNIX_SOCKET:-"/var/lib/php-fpm/run/php-fpm.sock"}
PHP_FPM_MAX_CHILDREN=${PHP_FPM_MAX_CHILDREN:-"75"}
PHP_FPM_MAX_REQUESTS=${PHP_FPM_MAX_REQUESTS:-"500"}
PHP_FPM_MAX_SPARE_SERVERS=${PHP_FPM_MAX_SPARE_SERVERS:-"3"}
PHP_FPM_MIN_SPARE_SERVERS=${PHP_FPM_MIN_SPARE_SERVERS:-"1"}
PHP_FPM_OUTPUT_BUFFER_SIZE=${PHP_FPM_OUTPUT_BUFFER_SIZE:-"0"}
PHP_FPM_PROCESS_MANAGER=${PHP_FPM_PROCESS_MANAGER:-"dynamic"}
PHP_FPM_START_SERVERS=${PHP_FPM_START_SERVERS:-"2"}
PHP_LOG_ACCESS_FILE=${PHP_LOG_ACCESS_FILE:-"access.log"}
PHP_LOG_ACCESS_FORMAT=${PHP_LOG_ACCESS_FORMAT:-"default"}
PHP_LOG_ERROR_FILE=${PHP_LOG_ERROR_FILE:-"error.log"}
PHP_LOG_LEVEL=${PHP_LOG_LEVEL:-"notice"}
PHP_LOG_LIMIT=${PHP_LOG_LIMIT:-"3072"}
PHP_LOG_LOCATION=${PHP_LOG_LOCATION:-"/www/logs/php-fpm"}
PHP_MEMORY_LIMIT=${PHP_MEMORY_LIMIT:-"128M"}
PHP_OPCACHE_INTERNED_STRINGS_BUFFER=${PHP_OPCACHE_INTERNED_STRINGS_BUFFER:-"8"}
PHP_OPCACHE_JIT_BUFFER_SIZE=${PHP_OPCACHE_JIT_BUFFER_SIZE:-"50M"}
PHP_OPCACHE_JIT_MODE=${PHP_OPCACHE_JIT_MODE:-"1255"}
PHP_OPCACHE_MAX_ACCELERATED_FILES=${PHP_OPCACHE_MAX_ACCELERATED_FILES:-"10000"}
PHP_OPCACHE_MAX_FILE_SIZE=${PHP_OPCACHE_MAX_FILE_SIZE:-"0"}
PHP_OPCACHE_MAX_WASTED_PERCENTAGE=${PHP_OPCACHE_MAX_WASTED_PERCENTAGE:-"5"}
PHP_OPCACHE_MEM_SIZE=${PHP_OPCACHE_MEM_SIZE:-"128"}
PHP_OPCACHE_OPTIMIZATION_LEVEL=${PHP_OPCACHE_OPTIMIZATION_LEVEL:-"0x7FFFBFF"}
PHP_OPCACHE_REVALIDATE_FREQ=${PHP_OPCACHE_REVALIDATE_FREQ:-"2"}
PHP_OPCACHE_SAVE_COMMENTS=${PHP_OPCACHE_SAVE_COMMENTS:-"1"}
PHP_OPCACHE_VALIDATE_TIMESTAMPS=${PHP_OPCACHE_VALIDATE_TIMESTAMPS:-"1"}
PHP_POST_MAX_SIZE=${PHP_POST_MAX_SIZE:-"2G"}
PHP_TIMEOUT=${PHP_TIMEOUT:-"180"}
PHP_UPLOAD_MAX_SIZE=${PHP_UPLOAD_MAX_SIZE:-"2G"}
PHP_VERSION=${PHP_VERSION:-$(php -v 2>/dev/null | grep "^PHP " | head -n 1 | awk '{print $2}')}
PHP_WEBROOT=${PHP_WEBROOT:-$NGINX_WEBROOT}

#Xdebug 2
PHP_XDEBUG_PROFILER_DIR=${PHP_XDEBUG_PROFILER_DIR:-"${PHP_LOG_LOCATION}/xdebug/"}
PHP_XDEBUG_PROFILER_ENABLE=${PHP_XDEBUG_PROFILER_ENABLE:-"0"}
PHP_XDEBUG_PROFILER_ENABLE_TRIGGER=${PHP_XDEBUG_PROFILER_ENABLE_TRIGGER:-"0"}
PHP_XDEBUG_REMOTE_AUTOSTART=${PHP_XDEBUG_REMOTE_AUTOSTART:-"1"}
PHP_XDEBUG_REMOTE_CONNECT_BACK=${PHP_XDEBUG_REMOTE_CONNECT_BACK:-"0"}
PHP_XDEBUG_REMOTE_ENABLE=${PHP_XDEBUG_REMOTE_ENABLE:-"1"}
PHP_XDEBUG_REMOTE_HANDLER=${PHP_XDEBUG_REMOTE_HANDLER:-"dbgp"}
PHP_XDEBUG_REMOTE_HOST=${PHP_XDEBUG_REMOTE_HOST:-"127.0.0.1"}
PHP_XDEBUG_REMOTE_PORT=${PHP_XDEBUG_REMOTE_PORT:-"9090"}

#Xdebug 3
PHP_XDEBUG_OUTPUT_DIR=${PHP_XDEBUG_OUTPUT_DIR:-"${PHP_LOG_LOCATION}/xdebug/"}
PHP_XDEBUG_MODE=${PHP_XDEBUG_MODE:-"develop"}
PHP_XDEBUG_START_WITH_REQUEST=${PHP_XDEBUG_START_WITH_REQUEST:-"default"}
PHP_XDEBUG_DISCOVER_CLIENT_HOST=${PHP_XDEBUG_DISCOVER_CLIENT_HOST:-"default"}
PHP_XDEBUG_CLIENT_HOST=${PHP_XDEBUG_CLIENT_HOST:-"127.0.0.1"}
PHP_XDEBUG_CLIENT_PORT=${PHP_XDEBUG_CLIENT_PORT:-"9003"}

if [ -f "/usr/sbin/unitd" ] ; then
    PHP_FPM_LISTEN_UNIX_GROUP=${PHP_FPM_LISTEN_UNIX_GROUP:-"${UNIT_GROUP}"}
    PHP_FPM_LISTEN_UNIX_USER=${PHP_FPM_LISTEN_UNIX_USER:-"${UNIT_USER}"}
    PHP_FPM_USER=${PHP_FPM_USER:-"${UNIT_USER}"}
    PHP_FPM_GROUP=${PHP_FPM_GROUP:-"${UNIT_GROUP}"}
fi

if [ -f "/usr/sbin/nginx" ] ; then
    PHP_FPM_LISTEN_UNIX_GROUP=${PHP_FPM_LISTEN_UNIX_GROUP:-"${NGINX_GROUP}"}
    PHP_FPM_LISTEN_UNIX_USER=${PHP_FPM_LISTEN_UNIX_USER:-"${NGINX_USER}"}
    PHP_FPM_USER=${PHP_FPM_USER:-"${NGINX_USER}"}
    PHP_FPM_GROUP=${PHP_FPM_GROUP:-"${NGINX_GROUP}"}
fi

if [ -z "${PHP_FPM_HOST}" ]; then
    case "${PHP_FPM_LISTEN_TYPE,,}" in
        tcp )
            PHP_FPM_HOST=127.0.0.1:${PHP_FPM_LISTEN_TCP_PORT}
        ;;
        unix )
            PHP_FPM_HOST=${PHP_FPM_LISTEN_UNIX_SOCKET}
        ;;
    esac
fi

if [ "${PHP_BASE:0:1}" != "8" ] ; then
    PHP_ENABLE_JSON=TRUE
fi

if [ "${PHP_ENABLE_REDIS,,}" = "true" ] ; then
    PHP_ENABLE_IGBINARY=TRUE
    PHP_ENABLE_MSGPACK=TRUE
fi

if [ "${PHP_ENABLE_MEMCACHED,,}" = "true" ] ; then
    PHP_ENABLE_IGBINARY=TRUE
    PHP_ENABLE_MSGPACK=TRUE
fi

